% =====================  PREAMBLE =====================
% Engine guard (LuaLaTeX)
\RequirePackage{ifluatex}
\ifluatex\RequirePackage{luatex85}\fi

% Fonts / typography
\usepackage{fontspec}
\setmainfont{Libertinus Serif}
\usepackage{unicode-math}
\usepackage[final]{microtype}

% Core utilities
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{array,colortbl}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usetikzlibrary{automata,positioning,arrows.meta,shapes.multipart,shapes.geometric,calc,decorations.pathmorphing,fit,patterns}
\usepackage{siunitx}
\sisetup{detect-all,round-mode=places,round-precision=2}
\usepackage{enumitem}
\usepackage{tcolorbox}
\tcbuselibrary{breakable,skins}
\usepackage{listings}
\usepackage{minted}[=v3]
\setminted{breaklines,breakanywhere,fontsize=\small,tabsize=2}
\usepackage{glossaries-extra}
\setabbreviationstyle{long-short}

% Bibliography (load BEFORE tabularx to avoid patch race)
\usepackage[backend=biber,style=numeric,sorting=none]{biblatex}
\addbibresource{references.bib}
\usepackage{tabularx}

\usepackage{pifont}
\usepackage{tocloft}
\renewcommand{\cftchapdotsep}{\cftdotsep}
\setlength{\cftbeforechapskip}{1.5em}
\usepackage{titlesec}

% Hyperref last (before custom macros that rely on it)
\usepackage{xcolor}
\usepackage[hidelinks]{hyperref}

% Watermark (visible draft)
\usepackage[printwatermark]{xwatermark}
\pdfcompresslevel=0
\newwatermark[allpages,color=gray!30,scale=0.4]{CONFIDENTIAL DRAFT}
\hypersetup{
  pdftitle={Project Sunflower: A Study in Steganographic Verification},
  pdfauthor={bilalobe},
  pdfsubject={Digital Watermarking and Distributed Systems},
  pdfkeywords={steganography, robotics, security, IoT, cipher, watermarking},
  pdflang={en}
}

% =====================  WATERMARK MACROS (expl3) =====================
\ExplSyntaxOn
% New: output stream for watermark index
\iow_new:N \g_wm_index_iow
\AtBeginDocument{\iow_open:Nn \g_wm_index_iow { \jobname.wmidx }}
\AtEndDocument{\iow_close:N \g_wm_index_iow }
\NewDocumentCommand \zws {} { \char_generate:nn { "200B } { 12 } }
\newcounter{wmcount}
\tl_new:N \g_thewmpages_tl
\prop_new:N \g_wm_meta_prop
\prop_new:N \g_wm_pages_prop
\seq_new:N  \g_wm_pages_tmp_seq
\seq_new:N  \l__wm_rows_seq
\bool_new:N \g_wm_store_extended_bool
\bool_new:N \g_wm_store_columns_bool
\bool_new:N \g_wm_show_raw_meta_bool
\NewDocumentCommand \EnableWatermarkExtended {} { \bool_gset_true:N \g_wm_store_extended_bool }
\NewDocumentCommand \EnableWatermarkColumns {} { \bool_gset_true:N \g_wm_store_columns_bool }
\NewDocumentCommand \EnableWatermarkRawMeta {} { \bool_gset_true:N \g_wm_show_raw_meta_bool }
\NewDocumentCommand \DisableWatermarkRawMeta {} { \bool_gset_false:N \g_wm_show_raw_meta_bool }
\seq_new:N \l__wm_split_seq

% Helpers
\NewDocumentCommand \wmUniquePages {} {
  \seq_clear:N \g_wm_pages_tmp_seq
  \prop_map_inline:Nn \g_wm_pages_prop { \seq_put_right:Nn \g_wm_pages_tmp_seq { ##1 } }
  \seq_sort:Nn \g_wm_pages_tmp_seq { \int_compare:nNnTF {##1} < {##2} { \sort_return_same: } { \sort_return_swapped: } }
  \tl_clear:N \l_tmpa_tl
  \seq_map_inline:Nn \g_wm_pages_tmp_seq { \tl_if_empty:NF \l_tmpa_tl { \tl_put_right:Nn \l_tmpa_tl { ,~ } } \tl_put_right:Nn \l_tmpa_tl { ##1 } }
  \tl_use:N \l_tmpa_tl
}
\NewDocumentCommand \wmUniquePageCount {} { \prop_count:N \g_wm_pages_prop }
\NewDocumentCommand \thewmpages {} { \tl_use:N \g_thewmpages_tl }
\NewDocumentCommand \wmExtendedList {} {\wmExtendedTable}
\NewDocumentCommand \wmExtendedTable {} {
  \bool_if:NF \g_wm_store_extended_bool { \textit{(Extended watermark metadata disabled; call \texttt{\string\EnableWatermarkExtended}.)} }
  \bool_if:NT \g_wm_store_extended_bool {
    \begingroup
      \small
      % Prepare sortable sequence: each item = page|line|col|key|raw
      \seq_clear:N \l__wm_rows_seq
      \prop_map_inline:Nn \g_wm_meta_prop {%% key=##1 val=##2 (page|line|col)
        \tl_set:Nn \l_tmpa_tl { ##2 }
        \seq_set_split:Nnn \l__wm_split_seq {|}{\l_tmpa_tl}
        \seq_put_right:Nx \l__wm_rows_seq {\seq_item:Nn \l__wm_split_seq {1}|\seq_item:Nn \l__wm_split_seq {2}|\seq_item:Nn \l__wm_split_seq {3}|##1|##2}
      }
      % Sort by page then line numerically (stable on ties)
      \seq_sort:Nn \l__wm_rows_seq {
        \seq_set_split:Nnn \l__wm_split_seq {|}{##1}
        \int_set:Nn \l_tmpa_int { \seq_item:Nn \l__wm_split_seq {1} }
        \int_set:Nn \l_tmpb_int { \seq_item:Nn \l__wm_split_seq {2} }
        \seq_set_split:Nnn \l__wm_split_seq {|}{##2}
        \int_set:Nn \l_tmpc_int { \seq_item:Nn \l__wm_split_seq {1} }
        \int_set:Nn \l_tmpd_int { \seq_item:Nn \l__wm_split_seq {2} }
        \int_compare:nNnTF {\l_tmpa_int} < {\l_tmpc_int} {\sort_return_same:} {
          \int_compare:nNnTF {\l_tmpa_int} > {\l_tmpc_int} {\sort_return_swapped:} {
            \int_compare:nNnTF {\l_tmpb_int} < {\l_tmpd_int} {\sort_return_same:} {
              \int_compare:nNnTF {\l_tmpb_int} > {\l_tmpd_int} {\sort_return_swapped:} {\sort_return_same:}
            }
          }
        }
      }
      \bool_if:NTF \g_wm_show_raw_meta_bool
        {\begin{tabularx}{\linewidth}{@{}r c c c X@{}}}
        {\begin{tabularx}{\linewidth}{@{}r c c c@{}}}
      \toprule
      \# & Pg & Line & Col(em)%
      \bool_if:NT \g_wm_show_raw_meta_bool { & Raw Meta } \\
      \midrule
        \seq_map_inline:Nn \l__wm_rows_seq {%% item=page|line|col|key|raw
          \seq_set_split:Nnn \l__wm_split_seq {|}{##1}
          \seq_item:Nn \l__wm_split_seq {4} & \seq_item:Nn \l__wm_split_seq {1} & \seq_item:Nn \l__wm_split_seq {2} & \seq_item:Nn \l__wm_split_seq {3}%
          \bool_if:NT \g_wm_show_raw_meta_bool { & \seq_item:Nn \l__wm_split_seq {5} } \\
        }
        % make sure the last row is formally closed even when
        % \l__wm_rows_seq is empty (avoids misplaced \noalign errors)
        \tabularnewline
        \bottomrule
        \end{tabularx}
    \endgroup
  }
}

% Injection macro
\NewDocumentCommand \injectZWS { m } {
  \stepcounter{wmcount}
  % Expand page number now (avoid late \thepage expansion giving identical pages)
  \tl_set:Nx \l_tmpb_tl { \int_use:c { c@page } }
  \tl_if_empty:NF \g_thewmpages_tl { \tl_gput_right:Nn \g_thewmpages_tl { ,~ } }
  \tl_gput_right:NV \g_thewmpages_tl \l_tmpb_tl
  \prop_if_in:NVF \g_wm_pages_prop \l_tmpb_tl { \prop_gput:NVn \g_wm_pages_prop \l_tmpb_tl { 1 } }
  \bool_if:NT \g_wm_store_extended_bool {
    % Column capture (approx) if enabled
    \bool_if:NT \g_wm_store_columns_bool { \pdfsavepos }
    \tl_set:Nx \l_tmpa_tl { \l_tmpb_tl|\the\inputlineno| }
    \bool_if:NT \g_wm_store_columns_bool {
      \tl_put_right:Nx \l_tmpa_tl { \fp_eval:n { round( ( (\dim_eval:n{\pdflastxpos sp}) / (1em) ), 2 ) } }
    }
    \bool_if:NF \g_wm_store_columns_bool { \tl_put_right:Nn \l_tmpa_tl { -- } }
    \prop_gput:NnV \g_wm_meta_prop { \int_use:c { c@wmcount } } { \l_tmpa_tl }
  }
  % Write index line: WM|<seq>|page=<p>|line=<line>|col=<col or ->
  \iow_now:Nx \g_wm_index_iow { WM|\int_use:c { c@wmcount }|page=\l_tmpb_tl|line=\the\inputlineno|col=\bool_if:NTF \g_wm_store_columns_bool {\fp_eval:n { round( ( (\dim_eval:n{\pdflastxpos sp}) / (1em) ), 2 ) }}{--} }
  #1 \zws
}
\ExplSyntaxOff

% =====================  FORMATTING TWEAKS =====================
\setlength{\parskip}{0.5em}
\setlength{\parindent}{0pt}
\emergencystretch=1em

% Glossaries
\makeglossaries
\input{glossary_entries}

% Project macros
\input{macros}
